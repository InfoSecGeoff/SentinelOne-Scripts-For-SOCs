<#
.SYNOPSIS
    Analyze SentinelOne fileless malware threats to distinguish real attacks from false positives.

.DESCRIPTION
    This script retrieves and analyzes fileless malware threats from SentinelOne, providing detailed 
    breakdowns to help identify genuine fileless attacks versus false positives based on frequency, 
    timing, behavioral patterns, and process characteristics. The script handles pagination 
    automatically and provides comprehensive statistics with multiple export formats.
    
    By default, the script analyzes threats from the past year, looking for patterns that indicate
    fileless malware activity including PowerShell attacks, memory injection, reflective DLL loading,
    Office macros, script-based attacks, and other Living off the Land (LOLBin) techniques.

.PARAMETER BaseURL
    The base URL of your SentinelOne console (e.g., "https://usea1-swprd1.sentinelone.net")

.PARAMETER APIToken
    Your SentinelOne API token

.PARAMETER StartDate
    Optional. Filter threats created on or after this date. Format: "yyyy-MM-ddTHH:mm:ss.fffZ"
    If not specified, defaults to 1 year ago.

.PARAMETER EndDate
    Optional. Filter threats created on or before this date. Format: "yyyy-MM-ddTHH:mm:ss.fffZ"
    If not specified, defaults to current date/time.

.PARAMETER SiteIds
    Optional. Array of Site IDs to filter by.

.PARAMETER GroupIds
    Optional. Array of Group IDs to filter by.

.PARAMETER GroupNames
    Optional. Array of Group Names to filter by (case-insensitive partial match).
    The script will automatically lookup the Group IDs.

.PARAMETER ClientNames
    Optional. Array of Client/Site Names to filter by (case-insensitive partial match).
    The script will automatically lookup the Site IDs.

.PARAMETER ConfidenceLevels
    Optional. Array of confidence levels to filter by. Valid values: "malicious", "suspicious", "n/a"
    Default: "malicious", "suspicious"

.PARAMETER OutputFormat
    Optional. Output format: "Console", "CSV", "JSON", "HTML", or "All". Default: "Console"

.PARAMETER OutputPath
    Optional. Path for output files when using CSV, JSON, or HTML formats.
    Default: Current directory with timestamp.

.PARAMETER Limit
    Optional. Number of results per page (1-1000). Default: 1000

.EXAMPLE
    Get-S1FilelessMalwareAnalysis.ps1 -BaseURL "https://usea1-swprd1.sentinelone.net" -APIToken "YourAPIToken"
    
    Gets fileless malware analysis for the past year and displays in console.

.EXAMPLE
    Get-S1FilelessMalwareAnalysis.ps1 -BaseURL "https://usea1-swprd1.sentinelone.net" -APIToken "YourAPIToken" -OutputFormat "All"
    
    Analyzes fileless malware and exports to all formats (Console, CSV, JSON, HTML).

.EXAMPLE
    Get-S1FilelessMalwareAnalysis.ps1 -BaseURL "https://usea1-swprd1.sentinelone.net" -APIToken "YourAPIToken" -GroupNames @("Acme Corp", "Contoso Solutions") -OutputFormat "HTML"
    
    Analyzes fileless malware for specific customer groups and generates HTML report.

.EXAMPLE
    Get-S1FilelessMalwareAnalysis.ps1 -BaseURL "https://usea1-swprd1.sentinelone.net" -APIToken "YourAPIToken" -ClientNames @("Acme Corp", "Contoso Ltd") -OutputFormat "All"
    
    Analyzes fileless malware for specific clients and exports to all formats.

.EXAMPLE
    Get-S1FilelessMalwareAnalysis.ps1 -BaseURL "https://usea1-swprd1.sentinelone.net" -APIToken "YourAPIToken" -ConfidenceLevels @("malicious") -StartDate "2024-01-01T00:00:00.000Z" -EndDate "2024-12-31T23:59:59.999Z" -OutputFormat "HTML"
    
    Analyzes only high-confidence fileless malware for 2024 and generates HTML report.

.NOTES
    Author: Geoff Tankersley
    Requires: PowerShell 5.1 or higher
#>

[CmdletBinding()]
param (
    [Parameter(Mandatory=$true)]
    [string]$BaseURL,
    
    [Parameter(Mandatory=$true)]
    [string]$APIToken,
    
    [Parameter(Mandatory=$false)]
    [string]$StartDate,
    
    [Parameter(Mandatory=$false)]
    [string]$EndDate,
    
    [Parameter(Mandatory=$false)]
    [string[]]$SiteIds,
    
    [Parameter(Mandatory=$false)]
    [string[]]$GroupIds,
    
    [Parameter(Mandatory=$false)]
    [string[]]$GroupNames,
    
    [Parameter(Mandatory=$false)]
    [string[]]$ClientNames,
    
    [Parameter(Mandatory=$false)]
    [ValidateSet("malicious", "suspicious", "n/a")]
    [string[]]$ConfidenceLevels = @("malicious", "suspicious"),
    
    [Parameter(Mandatory=$false)]
    [ValidateSet("Console", "CSV", "JSON", "HTML", "All")]
    [string]$OutputFormat = "Console",
    
    [Parameter(Mandatory=$false)]
    [string]$OutputPath,
    
    [Parameter(Mandatory=$false)]
    [ValidateRange(1, 1000)]
    [int]$Limit = 1000
)

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

if (-not $StartDate) {
    $StartDate = (Get-Date).AddYears(-1).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
}
if (-not $EndDate) {
    $EndDate = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
}

if (-not $OutputPath) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $OutputPath = Join-Path (Get-Location) "S1_FilelessMalware_$timestamp"
}

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "SentinelOne Fileless Malware Analysis" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Date Range: $StartDate to $EndDate" -ForegroundColor Yellow
Write-Host "Confidence Levels: $($ConfidenceLevels -join ', ')" -ForegroundColor Yellow
if ($ClientNames) {
    Write-Host "Client Filter: $($ClientNames -join ', ')" -ForegroundColor Yellow
}

$headers = @{
    "Authorization" = "ApiToken $APIToken"
    "Content-Type" = "application/json"
}

$allThreats = @()
$cursor = $null
$pageCount = 1
$totalProcessed = 0

Write-Host "`nRetrieving threats from SentinelOne..." -ForegroundColor Yellow

try {
    do {
        $threatsUrl = "$BaseURL/web/api/v2.1/threats?limit=$Limit"
        
        if ($cursor) {
            $threatsUrl += "&cursor=$cursor"
        }
    
        $threatsUrl += "&createdAt__gte=$StartDate"
        $threatsUrl += "&createdAt__lte=$EndDate"
        
        if ($ConfidenceLevels) {
            $confidenceFilter = $ConfidenceLevels -join ","
            $threatsUrl += "&confidenceLevels=$confidenceFilter"
        }

        if ($GroupNames) {
            Write-Host "Looking up Group IDs for specified group names..." -ForegroundColor Yellow
            $groupsUrl = "$BaseURL/web/api/v2.1/groups?limit=1000"
            $groupsResponse = Invoke-RestMethod -Uri $groupsUrl -Method 'GET' -Headers $headers
            
            $matchedGroupIds = @()
            foreach ($groupName in $GroupNames) {
                $matchedGroups = $groupsResponse.data | Where-Object { $_.name -imatch [regex]::Escape($groupName) }
                if ($matchedGroups) {
                    foreach ($group in $matchedGroups) {
                        $matchedGroupIds += $group.id
                        Write-Host "  Found group: $($group.name) (ID: $($group.id))" -ForegroundColor Green
                    }
                }
            }
            
            if ($matchedGroupIds.Count -gt 0) {
                $groupFilter = $matchedGroupIds -join ","
                $threatsUrl += "&groupIds=$groupFilter"
                Write-Host "  Filtering by $($matchedGroupIds.Count) matched groups" -ForegroundColor Green
            } else {
                Write-Host "  No matching groups found. Exiting." -ForegroundColor Red
                return
            }
        }
        
        if ($ClientNames) {
            Write-Host "Looking up Site IDs for specified client names..." -ForegroundColor Yellow
            $sitesUrl = "$BaseURL/web/api/v2.1/sites?limit=1000"
            $sitesResponse = Invoke-RestMethod -Uri $sitesUrl -Method 'GET' -Headers $headers
            
            $matchedSiteIds = @()
            foreach ($clientName in $ClientNames) {
                $matchedSites = $sitesResponse.data | Where-Object { $_.name -imatch [regex]::Escape($clientName) }
                if ($matchedSites) {
                    foreach ($site in $matchedSites) {
                        $matchedSiteIds += $site.id
                        Write-Host "  Found client: $($site.name) (ID: $($site.id))" -ForegroundColor Green
                    }
                }
            }
            
            if ($matchedSiteIds.Count -gt 0) {
                $siteFilter = $matchedSiteIds -join ","
                $threatsUrl += "&siteIds=$siteFilter"
                Write-Host "  Filtering by $($matchedSiteIds.Count) matched client sites" -ForegroundColor Green
            } else {
                Write-Host "  No matching clients found. Exiting." -ForegroundColor Red
                return
            }
        }
        
        if ($GroupIds) {
            $groupFilter = $GroupIds -join ","
            $threatsUrl += "&groupIds=$groupFilter"
        }
        
        if ($SiteIds) {
            $siteFilter = $SiteIds -join ","
            $threatsUrl += "&siteIds=$siteFilter"
        }
        
        Write-Host "  Fetching page $pageCount..." -ForegroundColor Gray
        $threatsResponse = Invoke-RestMethod -Uri $threatsUrl -Method 'GET' -Headers $headers
        
        if ($null -ne $threatsResponse.data -and $threatsResponse.data.Count -gt 0) {
            Write-Host "    Retrieved $($threatsResponse.data.Count) threats (Total: $($allThreats.Count + $threatsResponse.data.Count))" -ForegroundColor Gray
            
            foreach ($threat in $threatsResponse.data) {
                $isFilelessMalware = $false
                $filelessIndicators = @()
                
                if ($null -ne $threat.threatInfo.isFileless -and $threat.threatInfo.isFileless -eq $true) {
                    $isFilelessMalware = $true
                    $filelessIndicators += "Direct Fileless Flag: True"
                }
                
                if ($threat.threatInfo.threatName) {
                    if ($threat.threatInfo.threatName -match "fileless|memory.*inject|process.*hollow|reflective.*dll|powershell.*encoded|living.*off.*land|lolbas|lolbin|macro.*malware|script.*based|dropper.*less|in.*memory") {
                        $isFilelessMalware = $true
                        $filelessIndicators += "Threat Name Pattern: $($threat.threatInfo.threatName)"
                    }
                }
                
                if ($threat.threatInfo.classification) {
                    if ($threat.threatInfo.classification -match "fileless|memory|script|macro|powershell|living.*off.*land|process.*injection") {
                        $isFilelessMalware = $true
                        $filelessIndicators += "Classification: $($threat.threatInfo.classification)"
                    }
                }
                
                if ($threat.threatInfo.maliciousProcessArguments) {
                    if ($threat.threatInfo.maliciousProcessArguments -match "-enc.*[A-Za-z0-9+/=]{20,}|-encoded.*command|frombase64|invoke.*expression|downloadstring|iex|reflection\.assembly|system\.reflection|memorystream|gzipstream|invoke.*mimikatz|invoke.*shellcode|start.*process.*hidden|bypass.*execution.*policy") {
                        $isFilelessMalware = $true
                        $filelessIndicators += "Malicious Process Args: Encoded/Reflective execution detected"
                    }
                }
                
                if ($threat.threatInfo.originatorProcess) {
                    if ($threat.threatInfo.originatorProcess -match "powershell|wscript|cscript|mshta|rundll32|regsvr32|msiexec|certutil|bitsadmin|wmic|forfiles|pcalua|installutil|regasm|regsvcs|msxsl") {
                        $isFilelessMalware = $true
                        $filelessIndicators += "Living off the Land Binary: $($threat.threatInfo.originatorProcess)"
                    }
                }
                
                if ($threat.threatInfo.detectionType -match "behavioral|dynamic" -and 
                    ($threat.threatInfo.filePath -eq $null -or $threat.threatInfo.filePath -eq "" -or 
                     $threat.threatInfo.filePath -match "memory|temp|appdata.*local.*temp|users.*.*temp")) {
                    $isFilelessMalware = $true
                    $filelessIndicators += "Memory-based Detection: Behavioral detection with minimal file artifacts"
                }
                
                if ($threat.threatInfo.macroModules -and $threat.threatInfo.macroModules.Count -gt 0) {
                    $isFilelessMalware = $true
                    $filelessIndicators += "Macro Modules Detected: $($threat.threatInfo.macroModules.Count) modules"
                }
                
                if ($threat.threatInfo.browserType -and $threat.threatInfo.browserType -ne "" -and 
                    ($threat.threatInfo.threatName -match "exploit|javascript|browser|web.*based" -or 
                     $threat.threatInfo.classification -match "browser|web|javascript")) {
                    $isFilelessMalware = $true
                    $filelessIndicators += "Browser-based Attack: $($threat.threatInfo.browserType)"
                }
                
                if ($isFilelessMalware) {
                    $attackVector = "Unknown"
                    if ($threat.threatInfo.macroModules -and $threat.threatInfo.macroModules.Count -gt 0) {
                        $attackVector = "Office Macro"
                    } elseif ($threat.threatInfo.browserType) {
                        $attackVector = "Browser-based"
                    } elseif ($threat.threatInfo.originatorProcess -match "powershell") {
                        $attackVector = "PowerShell"
                    } elseif ($threat.threatInfo.originatorProcess -match "wscript|cscript|mshta") {
                        $attackVector = "Script Engine"
                    } elseif ($threat.threatInfo.originatorProcess -match "rundll32|regsvr32") {
                        $attackVector = "DLL Abuse"
                    } elseif ($threat.threatInfo.maliciousProcessArguments -match "reflection|assembly|memorystream") {
                        $attackVector = "Reflective Loading"
                    } else {
                        $attackVector = "Process Injection/Memory"
                    }
                    
                    $sophisticationLevel = "Low"
                    if ($threat.threatInfo.maliciousProcessArguments -match "-enc.*[A-Za-z0-9+/=]{50,}|gzipstream|reflection\.assembly") {
                        $sophisticationLevel = "High"
                    } elseif ($threat.threatInfo.maliciousProcessArguments -match "frombase64|downloadstring|invoke.*expression") {
                        $sophisticationLevel = "Medium"
                    } elseif ($threat.threatInfo.macroModules -and $threat.threatInfo.macroModules.Count -gt 2) {
                        $sophisticationLevel = "Medium"
                    }
                    
                    $filelessThreat = [PSCustomObject]@{
                        'ThreatID' = $threat.id
                        'ThreatName' = $threat.threatInfo.threatName
                        'Classification' = $threat.threatInfo.classification
                        'ConfidenceLevel' = $threat.threatInfo.confidenceLevel
                        'IsFileless' = if ($null -ne $threat.threatInfo.isFileless) { $threat.threatInfo.isFileless } else { "Unknown" }
                        'AttackVector' = $attackVector
                        'SophisticationLevel' = $sophisticationLevel
                        'CreatedAt' = $threat.threatInfo.createdAt
                        'CreatedDate' = if ($threat.threatInfo.createdAt) { 
                            [DateTime]::Parse($threat.threatInfo.createdAt).ToString("yyyy-MM-dd") 
                        } else { "N/A" }
                        'CreatedHour' = if ($threat.threatInfo.createdAt) { 
                            [DateTime]::Parse($threat.threatInfo.createdAt).ToString("HH:00") 
                        } else { "N/A" }
                        'AgentComputerName' = $threat.agentRealtimeInfo.agentComputerName
                        'CustomerName' = $threat.agentRealtimeInfo.siteName
                        'GroupName' = $threat.agentRealtimeInfo.groupName
                        'AgentId' = $threat.agentRealtimeInfo.agentId
                        'SiteName' = $threat.agentRealtimeInfo.siteName
                        'AgentOsType' = $threat.agentRealtimeInfo.agentOsType
                        'FilePath' = $threat.threatInfo.filePath
                        'FileExtension' = if ($threat.threatInfo.fileExtension) { $threat.threatInfo.fileExtension.ToLower() } else { "N/A" }
                        'ProcessUser' = $threat.threatInfo.processUser
                        'MaliciousProcessArguments' = $threat.threatInfo.maliciousProcessArguments
                        'OriginatorProcess' = $threat.threatInfo.originatorProcess
                        'BrowserType' = $threat.threatInfo.browserType
                        'MacroModuleCount' = if ($threat.threatInfo.macroModules) { $threat.threatInfo.macroModules.Count } else { 0 }
                        'InitiatedBy' = $threat.threatInfo.initiatedBy
                        'InitiatingUsername' = $threat.threatInfo.initiatingUsername
                        'DetectionEngines' = if ($threat.threatInfo.detectionEngines) { $threat.threatInfo.detectionEngines -join ";" } else { "N/A" }
                        'DetectionType' = $threat.threatInfo.detectionType
                        'MitigationStatus' = $threat.threatInfo.mitigationStatus
                        'IncidentStatus' = $threat.threatInfo.incidentStatus
                        'AnalystVerdict' = $threat.threatInfo.analystVerdict
                        'AutomaticallyResolved' = if ($null -ne $threat.threatInfo.automaticallyResolved) { $threat.threatInfo.automaticallyResolved } else { $false }
                        'FailedActions' = if ($null -ne $threat.threatInfo.failedActions) { $threat.threatInfo.failedActions } else { $false }
                        'MitigatedPreemptively' = if ($null -ne $threat.threatInfo.mitigatedPreemptively) { $threat.threatInfo.mitigatedPreemptively } else { $false }
                        'SHA256' = $threat.threatInfo.sha256
                        'MD5' = $threat.threatInfo.md5
                        'FileSize' = $threat.threatInfo.fileSize
                        'PublisherName' = $threat.threatInfo.publisherName
                        'Storyline' = $threat.threatInfo.storyline
                        'FilelessIndicators' = $filelessIndicators -join "; "
                    }
                    
                    $allThreats += $filelessThreat
                    $totalProcessed++
                }
            }
            
            if ($null -ne $threatsResponse.pagination -and $null -ne $threatsResponse.pagination.nextCursor) {
                $cursor = $threatsResponse.pagination.nextCursor
                $pageCount++
            } else {
                $cursor = $null
            }
        } else {
            $cursor = $null
        }
        
    } while ($null -ne $cursor -and $cursor -ne "null")
    
    Write-Host "`nTotal fileless malware threats found: $totalProcessed" -ForegroundColor Green
    
    if ($totalProcessed -eq 0) {
        Write-Host "No fileless malware threats found in the specified time period." -ForegroundColor Yellow
        return
    }
    
    $agentDailyStats = @{}
    foreach ($threat in $allThreats) {
        $agentKey = "$($threat.AgentComputerName)_$($threat.CreatedDate)"
        if ($agentDailyStats.ContainsKey($agentKey)) {
            $agentDailyStats[$agentKey].Count++
            $agentDailyStats[$agentKey].Threats += $threat
        } else {
            $agentDailyStats[$agentKey] = @{
                AgentName = $threat.AgentComputerName
                CustomerName = $threat.CustomerName
                Date = $threat.CreatedDate
                Count = 1
                Threats = @($threat)
            }
        }
    }
    
    $highActivityDays = $agentDailyStats.Values | Where-Object { $_.Count -ge 5 } | Sort-Object Count -Descending
    $isolatedIncidents = $agentDailyStats.Values | Where-Object { $_.Count -eq 1 } | Sort-Object Count -Descending
    $moderateActivity = $agentDailyStats.Values | Where-Object { $_.Count -ge 2 -and $_.Count -le 4 } | Sort-Object Count -Descending
    
    $groupStats = $allThreats | Group-Object -Property GroupName | 
                 Sort-Object Count -Descending | 
                 Select-Object @{Name="Group"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}}
    
    $siteStats = $allThreats | Group-Object -Property SiteName | 
                Sort-Object Count -Descending | 
                Select-Object @{Name="Site"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}}
    
    $agentStats = $allThreats | Group-Object -Property AgentComputerName | 
                 Sort-Object Count -Descending | 
                 Select-Object @{Name="Agent"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}}, 
                               @{Name="Site"; Expression={($_.Group | Select-Object -First 1).SiteName}}, 
                               @{Name="Customer"; Expression={($_.Group | Select-Object -First 1).CustomerName}} |
                 Select-Object -First 20
    
    $attackVectorStats = $allThreats | Group-Object -Property AttackVector | 
                        Sort-Object Count -Descending | 
                        Select-Object @{Name="Attack Vector"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}}
    
    $sophisticationStats = $allThreats | Group-Object -Property SophisticationLevel | 
                          Sort-Object Count -Descending | 
                          Select-Object @{Name="Sophistication Level"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}}
    
    $processStats = $allThreats | Where-Object { $_.OriginatorProcess -and $_.OriginatorProcess -ne "N/A" } |
                   Group-Object -Property OriginatorProcess | 
                   Sort-Object Count -Descending | 
                   Select-Object @{Name="Process"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}} |
                   Select-Object -First 20
    
    $threatNameStats = $allThreats | Group-Object -Property ThreatName | 
                      Sort-Object Count -Descending | 
                      Select-Object @{Name="Threat Name"; Expression={$_.Name}}, Count, @{Name="Percentage"; Expression={[math]::Round(($_.Count / $totalProcessed) * 100, 2)}} |
                      Select-Object -First 15
    
    $hourlyStats = $allThreats | Group-Object -Property CreatedHour | 
                  Sort-Object Name | 
                  Select-Object @{Name="Hour"; Expression={$_.Name}}, Count
    
    Write-Host "`n========================================" -ForegroundColor Cyan
    Write-Host "Summary Statistics" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host "Total Threats: $totalProcessed" -ForegroundColor Green
    Write-Host "High Activity Days (5+ threats): $($highActivityDays.Count)" -ForegroundColor Red
    Write-Host "Moderate Activity Days (2-4 threats): $($moderateActivity.Count)" -ForegroundColor Yellow
    Write-Host "Isolated Incidents (1 threat): $($isolatedIncidents.Count)" -ForegroundColor White
    if ($agentStats) {
        Write-Host "Most Affected Agent: $($agentStats[0].Agent) ($($agentStats[0].Count) threats)" -ForegroundColor White
    }
    if ($attackVectorStats) {
        Write-Host "Top Attack Vector: $($attackVectorStats[0].'Attack Vector') ($($attackVectorStats[0].Percentage)%)" -ForegroundColor White
    }
    
    if ($OutputFormat -eq "Console" -or $OutputFormat -eq "All") {
        Write-Host "`nAttack Vector Distribution:" -ForegroundColor Cyan
        $attackVectorStats | Format-Table -AutoSize
        
        Write-Host "`nSophistication Level:" -ForegroundColor Cyan
        $sophisticationStats | Format-Table -AutoSize
        
        Write-Host "`nMost Affected Agents (Top 20):" -ForegroundColor Cyan
        $agentStats | Format-Table -AutoSize
        
        Write-Host "`nSite/Client Distribution:" -ForegroundColor Cyan
        $siteStats | Select-Object -First 20 | Format-Table -AutoSize
        
        Write-Host "`nThreat Type Distribution (Top 15):" -ForegroundColor Cyan
        $threatNameStats | Format-Table -AutoSize
        
        Write-Host "`nProcess Analysis (Top 20):" -ForegroundColor Cyan
        if ($processStats) {
            $processStats | Format-Table -AutoSize
        } else {
            Write-Host "No process data available" -ForegroundColor Yellow
        }
    }
    
    if ($OutputFormat -in @("CSV", "All")) {
        Write-Host "`nExporting to CSV..." -ForegroundColor Yellow
        
        $threatsFile = "${OutputPath}_Threats.csv"
        $allThreats | Export-Csv -Path $threatsFile -NoTypeInformation
        Write-Host "  Threats exported to: $threatsFile" -ForegroundColor Green
        
        $attackVectorFile = "${OutputPath}_AttackVectors.csv"
        $attackVectorStats | Export-Csv -Path $attackVectorFile -NoTypeInformation
        Write-Host "  Attack vectors exported to: $attackVectorFile" -ForegroundColor Green
        
        $siteStatsFile = "${OutputPath}_SiteStats.csv"
        $siteStats | Export-Csv -Path $siteStatsFile -NoTypeInformation
        Write-Host "  Site statistics exported to: $siteStatsFile" -ForegroundColor Green
    }
    
    if ($OutputFormat -in @("JSON", "All")) {
        Write-Host "`nExporting to JSON..." -ForegroundColor Yellow
        
        $jsonData = @{
            Summary = @{
                DateRange = @{
                    Start = $StartDate
                    End = $EndDate
                }
                TotalThreats = $totalProcessed
                HighActivityDays = $highActivityDays.Count
                ModerateActivityDays = $moderateActivity.Count
                IsolatedIncidents = $isolatedIncidents.Count
            }
            Threats = $allThreats
            Statistics = @{
                Groups = $groupStats
                Sites = $siteStats
                Agents = $agentStats
                AttackVectors = $attackVectorStats
                SophisticationLevels = $sophisticationStats
                Processes = $processStats
                ThreatNames = $threatNameStats
                HourlyDistribution = $hourlyStats
            }
        }
        
        $jsonFile = "${OutputPath}.json"
        $jsonData | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonFile -Encoding UTF8
        Write-Host "  JSON exported to: $jsonFile" -ForegroundColor Green
    }
    
    if ($OutputFormat -in @("HTML", "All")) {
        Write-Host "`nExporting to HTML..." -ForegroundColor Yellow
        
        $htmlContent = @"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelOne Fileless Malware Analysis Report</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #6f42c1; }
        .header h1 { color: #6f42c1; margin: 0; font-size: 2.5em; }
        .header p { color: #666; margin: 10px 0; font-size: 1.1em; }
        .summary-box { background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center; }
        .summary-box h2 { margin: 0 0 10px 0; }
        .summary-box .count { font-size: 3em; font-weight: bold; margin: 10px 0; }
        .section { margin-bottom: 40px; }
        .section h2 { color: #6f42c1; border-bottom: 2px solid #6f42c1; padding-bottom: 10px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; word-wrap: break-word; max-width: 300px; }
        th { background-color: #6f42c1; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f5f5f5; }
        .metric-card { display: inline-block; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 10px; min-width: 200px; text-align: center; }
        .metric-card h3 { margin: 0 0 10px 0; color: #6f42c1; }
        .metric-card .value { font-size: 2em; font-weight: bold; color: #333; }
        .alert { background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin: 15px 0; }
        .alert.success { background-color: #d4edda; border-color: #c3e6cb; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-3 { grid-template-columns: 1fr; } }
        .code { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 2px 4px; font-family: monospace; font-size: 0.9em; }
        .risk-high { color: #dc3545; font-weight: bold; }
        .risk-medium { color: #fd7e14; font-weight: bold; }
        .risk-low { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Fileless Malware Analysis Report</h1>
            <p><strong>Analysis Period:</strong> $StartDate to $EndDate</p>
"@

        if ($ClientNames) {
            $htmlContent += "            <p><strong>Client Filter:</strong> $($ClientNames -join ', ')</p>`n"
        }
        
        $currentYear = (Get-Date).Year
        
        $htmlContent += @"
            <p><strong>Generated:</strong> $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
        </div>
        
        <div class="summary-box">
            <h2>Total Fileless Malware Threats</h2>
            <div class="count">$totalProcessed</div>
        </div>
        
        <div class="section">
            <h2>üéØ Activity Analysis</h2>
            <div class="grid-3">
                <div class="metric-card">
                    <h3>High Activity Days</h3>
                    <div class="value" style="color: #dc3545;">$($highActivityDays.Count)</div>
                    <small>5+ threats per day</small>
                </div>
                <div class="metric-card">
                    <h3>Moderate Activity</h3>
                    <div class="value" style="color: #ffc107;">$($moderateActivity.Count)</div>
                    <small>2-4 threats per day</small>
                </div>
                <div class="metric-card">
                    <h3>Isolated Incidents</h3>
                    <div class="value" style="color: #28a745;">$($isolatedIncidents.Count)</div>
                    <small>1 threat per day</small>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üèπ Attack Vector Distribution</h2>
            <table>
                <thead>
                    <tr>
                        <th>Attack Vector</th>
                        <th>Count</th>
                        <th>Percentage</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody>
"@

        foreach ($stat in $attackVectorStats) {
            $riskLevel = switch ($stat.'Attack Vector') {
                "Reflective Loading" { "High" }
                "Process Injection/Memory" { "High" }
                "PowerShell" { "High" }
                "Office Macro" { "Medium" }
                "Browser-based" { "Medium" }
                "Script Engine" { "Medium" }
                "DLL Abuse" { "Medium" }
                default { "Low" }
            }
            $riskClass = switch ($riskLevel) {
                "High" { "risk-high" }
                "Medium" { "risk-medium" }
                "Low" { "risk-low" }
            }
            $htmlContent += "<tr><td>$($stat.'Attack Vector')</td><td>$($stat.Count)</td><td>$($stat.Percentage)%</td><td><span class='$riskClass'>$riskLevel</span></td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üî¨ Sophistication Level</h2>
            <table>
                <thead>
                    <tr>
                        <th>Sophistication</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        foreach ($stat in $sophisticationStats) {
            $htmlContent += "<tr><td>$($stat.'Sophistication Level')</td><td>$($stat.Count)</td><td>$($stat.Percentage)%</td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üíª Most Affected Agents</h2>
            <table>
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Count</th>
                        <th>Percentage</th>
                        <th>Site</th>
                        <th>Customer</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        foreach ($stat in $agentStats) {
            $htmlContent += "<tr><td>$($stat.Agent)</td><td>$($stat.Count)</td><td>$($stat.Percentage)%</td><td>$($stat.Site)</td><td>$($stat.Customer)</td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üè¢ Site/Client Distribution</h2>
            <table>
                <thead>
                    <tr>
                        <th>Site/Client</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        foreach ($stat in $siteStats) {
            $htmlContent += "<tr><td>$($stat.Site)</td><td>$($stat.Count)</td><td>$($stat.Percentage)%</td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üéØ Threat Types</h2>
            <table>
                <thead>
                    <tr>
                        <th>Threat Name</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        foreach ($stat in $threatNameStats) {
            $htmlContent += "<tr><td>$($stat.'Threat Name')</td><td>$($stat.Count)</td><td>$($stat.Percentage)%</td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>‚öôÔ∏è Process Analysis</h2>
            <table>
                <thead>
                    <tr>
                        <th>Process</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        if ($processStats) {
            foreach ($stat in $processStats) {
                $htmlContent += "<tr><td><span class='code'>$($stat.Process)</span></td><td>$($stat.Count)</td><td>$($stat.Percentage)%</td></tr>`n"
            }
        } else {
            $htmlContent += "<tr><td colspan='3'>No process data available</td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üìä Hourly Distribution</h2>
            <table>
                <thead>
                    <tr>
                        <th>Hour</th>
                        <th>Threat Count</th>
                        <th>Typical Activity</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        foreach ($stat in $hourlyStats) {
            $activity = "Normal"
            $hour = [int]$stat.Hour.Split(':')[0]
            if ($hour -ge 9 -and $hour -le 17) {
                $activity = "Business Hours"
            } elseif ($hour -ge 18 -and $hour -le 23) {
                $activity = "Evening"
            } else {
                $activity = "After Hours (Higher Risk)"
            }
            
            $htmlContent += "<tr><td>$($stat.Hour)</td><td>$($stat.Count)</td><td>$activity</td></tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üîç Detailed Threat Timeline</h2>
            <p>Complete list of all fileless malware threats with timestamps and details:</p>
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Agent</th>
                        <th>Site/Client</th>
                        <th>Threat Name</th>
                        <th>Attack Vector</th>
                        <th>Process</th>
                        <th>Command Line Arguments</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
"@
        
        foreach ($threat in ($allThreats | Sort-Object CreatedAt -Descending)) {
            $timestamp = if ($threat.CreatedAt) {
                try {
                    [DateTime]::Parse($threat.CreatedAt).ToString("yyyy-MM-dd HH:mm:ss")
                } catch {
                    $threat.CreatedAt
                }
            } else {
                "N/A"
            }
            
            $cmdLine = if ($threat.MaliciousProcessArguments -and $threat.MaliciousProcessArguments -ne "N/A") {
                if ($threat.MaliciousProcessArguments.Length -gt 100) {
                    $threat.MaliciousProcessArguments.Substring(0, 97) + "..."
                } else {
                    $threat.MaliciousProcessArguments
                }
            } else {
                "N/A"
            }
            
            $htmlContent += "<tr>"
            $htmlContent += "<td>$timestamp</td>"
            $htmlContent += "<td>$($threat.AgentComputerName)</td>"
            $htmlContent += "<td>$($threat.SiteName)</td>"
            $htmlContent += "<td>$($threat.ThreatName)</td>"
            $htmlContent += "<td>$($threat.AttackVector)</td>"
            $htmlContent += "<td><span class='code'>$($threat.OriginatorProcess)</span></td>"
            $htmlContent += "<td><span class='code' style='font-size: 0.8em;'>$cmdLine</span></td>"
            $htmlContent += "<td>$($threat.IncidentStatus)</td>"
            $htmlContent += "</tr>`n"
        }
        
        $htmlContent += @"
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>üí° Analysis Summary</h2>
            <div class="alert success">
                <h4>Key Findings:</h4>
                <ul>
                    <li><strong>Total Fileless Threats:</strong> $totalProcessed threats detected</li>
                    <li><strong>Primary Attack Vector:</strong> $($attackVectorStats[0].'Attack Vector') ($($attackVectorStats[0].Percentage)%)</li>
                    <li><strong>High Activity Days:</strong> $($highActivityDays.Count) agent/day combinations with 5+ threats</li>
                    <li><strong>Most Affected Agent:</strong> $($agentStats[0].Agent) with $($agentStats[0].Count) threats</li>
                </ul>
            </div>
        </div>
        
        <div class="footer">
            <p>Report generated by SentinelOne Fileless Malware Analysis Script</p>
            <p>$currentYear</p>
        </div>
    </div>
</body>
</html>
"@
        
        $htmlFile = "${OutputPath}.html"
        $htmlContent | Out-File -FilePath $htmlFile -Encoding UTF8
        Write-Host "  HTML report exported to: $htmlFile" -ForegroundColor Green
    }
    
    Write-Host "`n========================================" -ForegroundColor Cyan
    Write-Host "Processing Complete!" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Cyan
    
    return $allThreats
    
} catch {
    Write-Host "`nError occurred:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
    Write-Host $_.ScriptStackTrace -ForegroundColor Red
}
